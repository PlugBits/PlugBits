# PlugBits Reports 開発まとめ（〜P3途中）

## 到達点（できていること）

### UI / Editor
- テンプレートライブラリ一覧表示（検索・ソート・グルーピング）
- Pickerモード対応
  - プラグインからテンプレ一覧を開く
  - テンプレ「選択」→ templateId を postMessage で返却
- テンプレ編集UI（/templates/:id/edit）
- 要素タブ：
  - Text要素で Kintoneフィールドコードをドロップダウン選択可能
  - フィールド一覧は Worker 経由で Kintone API から取得
- 割り当てタブ：
  - UI自体は存在
  - **要素タブで実装したフィールド取得ロジックを未統合（P3対象）**

### Kintone プラグイン
- 設定画面
  - workerBaseUrl（APIベースURL）
  - Worker API Key
  - templateId
  - attachmentFieldCode
  - kintoneApiToken（※URLに載せない方向で整理中）
- レコード詳細画面に「PDF出力（PlugBits）」ボタン追加
- PDF生成 → プレビュー → 添付フィールドに保存 の一連フロー実装済

### Worker
- /render エンドポイント実装
- user template / catalog template の分離
- Kintoneフィールド取得用 proxy API 実装（CORS対応）

---

## 現在発生している主問題（最重要）

### 1. Unknown user templateId エラー
Unknown user templateId: tpl_xxx
このテンプレは現在のWorker環境に存在しません

#### 原因の整理
- Editorが保存している Worker / tenant と
- プラグインが /render で叩いている Worker / tenant が不一致

主な要因：
- Editor が env の API_BASE_URL を使い続けている
- URLクエリの workerBaseUrl / kintoneBaseUrl / appId が保存時に正しく反映されていない
- tenantContext が local / cache 固定になっている可能性

→ **保存先WorkerとPDF出力Workerを100%一致させる必要あり**

---

### 2. 認証・トークン設計（方向性は決定済）
- URLに kintoneApiToken を載せる方式はNG（UX・セキュリティ）
- 認証単位は「会社（アプリ）」でOK
- エディタは本番でも必ず使う（フィールド割り当てがあるため）

決定事項：
- URLから API トークンは排除
- plugin → editor は postMessage による短命トークン受け渡し方式に移行予定
- ただし **先に Unknown template 問題を解消する**

---

## P3でやること（整理）

### P3-1（最優先）
- Editor側の templateService / tenant解決を修正
  - workerBaseUrl を URL クエリ最優先に
  - kintoneBaseUrl / appId も URL クエリ最優先
  - cache が原因なら URL変更時に再解決
- 保存した user template が
  - 同じ workerBaseUrl + tenant で
  - /render から確実に参照できる状態にする

### P3-2
- 割り当てタブに
  - 要素タブで実装済みの Kintoneフィールド取得・ドロップダウンを統合
  - 「同じ役割が2箇所にある」状態を整理

### P3-3（次フェーズ）
- URLにトークンを載せない認証フロー
  - postMessage による token hand-shake
  - sessionStorage 管理
