ğŸ“„ â‘  ã€ŒPlugBits Reports MVP å®Ÿè£…ã¾ã¨ã‚.mdã€
ä»¥ä¸‹ã‚’ãã®ã¾ã¾ PlugBits-Reports-MVP.md ã¨ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚
PlugBits Reports MVP â€“ å®Ÿè£…ã¾ã¨ã‚
ğŸ¯ ç›®çš„
kintoneãƒ¬ã‚³ãƒ¼ãƒ‰ç”»é¢ã®ãƒœã‚¿ãƒ³1ã¤ã§ PDF ã‚’ç”Ÿæˆ
PDFã¯External Workerï¼ˆCloudflareï¼‰ã§ç”Ÿæˆ
çµæœã‚’ãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤ºï¼‹æ·»ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸ä¿å­˜ï¼ˆå¾Œã§å®Ÿè£…ï¼‰
ğŸ”— ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦
kintone (Plugin)
     â†“ fetch (POST /render)
Cloudflare Worker (SaaS)
     â†“ renderTemplateToPdf
PDFç”Ÿæˆï¼ˆãƒ•ã‚©ãƒ³ãƒˆåŸ‹ã‚è¾¼ã¿ï¼‰
     â†“
HTTP Response (application/pdf)
ğŸ§± ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸€è¦§
Kintone Plugin
plugin/src/config/*
è¨­å®šç”»é¢ï¼šAPI URL / API Key / TemplateID / æ·»ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰
plugin/src/desktop/index.ts
ãƒ¬ã‚³ãƒ¼ãƒ‰è©³ç´°ç”»é¢ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ â†’ callRenderApi
fetch â†’ blob â†’ window.open
Cloudflare Worker
worker/src/index.ts
/render API
CORS
template or templateId å¯¾å¿œ
font load â†’ fetch å¤–éƒ¨URL
worker/src/fonts/fontLoader.ts
base64ã‚’å‰Šé™¤
external fetch:
async function getDefaultFontBytes(env) {
  const res = await fetch(env.FONT_SOURCE_URL);
  return new Uint8Array(await res.arrayBuffer());
}
renderTemplateToPdf
pdf-lib + fontkit
TemplateDefinition ã‚’æç”»ã™ã‚‹
shared/template.ts
TemplateDefinition
SAMPLE_TEMPLATEï¼ˆè¦‹ç©æ›¸ï¼‰
sampleData
ğŸ” è¨­å®š
Worker
wrangler.toml ã«ã¦
[vars]
FONT_SOURCE_URL = "https://raw.githubusercontent.com/...."
publish:
npx wrangler deploy
Kintone Plugin è¨­å®šç”»é¢
API Base URL
â†’ https://xxxx.workers.dev
API Key
â†’ ä»»æ„ï¼ˆå¾Œã§æœ¬ç•ªã¯å¿…é ˆï¼‰
Template ID
â†’ template_001
æ·»ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
â†’ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰
âš™ API å¥‘ç´„
Request (from plugin)
POST /render
Headers:
  x-api-key: "xxxx"

Body:
{
  "templateId": "template_001",
  "data": {
    "CustomerName": "ABC",
    "Items": [...],
    "TotalAmount": 12345
  }
}
Response
200 OK
Content-Type: application/pdf
(binary PDF)
ğŸ“Œ Worker Index ãƒã‚¤ãƒ©ã‚¤ãƒˆ
if (body.template) {
  template = body.template;
} else if (body.templateId) {
  template = getTemplateById(body.templateId);
} else {
  return 400;
}

const pdfBytes = await renderTemplateToPdf(
  template,
  body.data,
  fontBytes
);

return new Response(pdfBytes, {
  status: 200,
  headers: {
    ...CORS_HEADERS,
    "Content-Type": "application/pdf",
  },
});
ğŸ§© ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ
import { SAMPLE_TEMPLATE } from "../../shared/template.js";

function getTemplateById(id: string): TemplateDefinition {
  if (id === "template_001") return SAMPLE_TEMPLATE;
  throw new Error("Unknown templateId");
}
ğŸ“‰ Workerã‚µã‚¤ã‚ºå•é¡Œã®å¯¾ç­–
Before
ãƒ•ã‚©ãƒ³ãƒˆbase64ã‚’ Worker ã«åŒæ¢± â†’ 7MB
Freeãƒ—ãƒ©ãƒ³ã®åˆ¶é™3MBã‚’è¶…é
After
å¤–éƒ¨fetch â†’ åŒæ¢±ä¸è¦
Worker bundle < 3MB
publishæˆåŠŸ
ğŸ” ãƒ†ã‚¹ãƒˆæ‰‹é †
Worker URL ç¢ºèª
https://xxxx.workers.dev/
Kintone ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§è¨­å®š
â†’ API URL / Template ID
ãƒ¬ã‚³ãƒ¼ãƒ‰è©³ç´°ç”»é¢ã§
ã€ŒPDFå‡ºåŠ›ã€ãƒœã‚¿ãƒ³
æœŸå¾…çµæœï¼š
æ–°ã‚¿ãƒ–ã§ PDFè¡¨ç¤º
å¾Œã§ æ·»ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¿å­˜ã‚’è¿½åŠ äºˆå®š
ğŸ—º æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆMVPå®Œäº†å¾Œï¼‰
æ·»ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸ä¿å­˜
Workbook + multiple templates
Template designer UI
èª²é‡‘ãƒ¢ãƒ‡ãƒ«