# PlugBits Reports テンプレート管理 不具合対応まとめ

## 概要
テンプレート複製・保存後に UI 上でテンプレートが消える／戻る問題が発生していた。
調査の結果、**baseTemplateId と user template の templateId の混同**および
**fetch の競合（race condition）＋ログ過多による可視性低下**が原因だった。

---

## 発生していた症状

- 複製・保存直後はテンプレートが表示される
- その後 `refreshTemplates()` が走ると
  - 一瞬テンプレートが増える
  - 次の fetch で `template_001`（SAMPLE_TEMPLATE）のみに戻る
- Worker 側には user templates が大量に存在しているのに
  `fetchTemplates()` の結果が `[]` になることがあった

---

## 原因整理

### 1. ID の役割混同

| 種別 | 意味 |
|----|----|
| baseTemplateId | 配布テンプレ（catalog / base）の ID（例: `list_v1`） |
| templateId / TemplateDefinition.id | ユーザー個別テンプレの ID（例: `tpl_xxx`） |

- user template の `templateId` と `baseTemplateId` は **一致しないのが正常**
- `fetchBaseTemplate()` は **baseTemplateId をキーに取得**
- `baseMap` の key は **base template の id**

👉 この前提がコード上・思考上で曖昧になっていた

---

### 2. fetch の競合（Race Condition）

- `refreshTemplates()` が短時間に複数回走る
- 後から返ってきた「古い fetch 結果」が state を上書き
- 結果として「テンプレートが消える」挙動に見えた

---

### 3. コンソールログ過多

- 正常系ログが大量に出ていた
- 本当に重要な異常ログが埋もれていた
- 状態把握が困難になっていた

---

## 実施した対応

### 1. fetchSeq によるレース対策（Zustand store）

- `fetchSeq` を state に追加
- `refreshTemplates()` 実行時にシーケンス番号をインクリメント
- fetch 完了時に
  ```ts
  if (get().fetchSeq !== seq) return;
で古い結果を破棄
2. コメントの明文化
templateService.ts に以下を明確化
baseTemplateId と templateId の役割差
fetchBaseTemplate の前提
user template と base template の関係
「なぜこの実装なのか（Why）」が分かるコメントを追加
3. コンソールログ整理
毎回出ていた正常系ログを削除 or console.debug に変更
以下のみを残す方針に統一
fetch 失敗
想定外の empty
base template 不一致
stale fetch を検出したケース
可能な箇所は if (import.meta.env.DEV) で囲った
現在の状態（結論）
Worker 側の user templates が すべて UI に表示される
複製 → 保存 → 再取得しても消えない
fetch の挙動が安定
コンソールログが「意味のあるものだけ」になった
👉 今回の不具合は解消済み。成功と言ってよい状態。
今後の改善余地（メモ）
古い user templates を整理する UI
debugLogger ユーティリティ化
fetch / cache 戦略の整理
tenant context の永続化（local 判定の明確化）

---

## P0 確認ポイント（テンプレ整理）

- Active タブで新規作成/複製 → 保存後も Active 一覧に残る
- Archive → Archived タブへ移動、Unarchive → Active へ戻る
- Delete → Trash タブへ移動、Restore → Active へ戻る
- Trash の Delete permanently は確認ダイアログ後に完全削除される
- baseTemplateId ごとのグルーピングが表示され、折りたたみが動作する
- タブ切替を連打しても一覧が崩れない（stale fetch が捨てられる）

## P1 確認ポイント（検索・並び順・再読込）

- Sort を切り替えると、グループ内の並びが Updated/Name/Created に反映される
- Search templates... で name 部分一致（大文字小文字無視）が動く
- 初回ロードは Loading...、再読込時は一覧を保持しつつ Refreshing... 表示になる

## P2 挙動メモ（編集ガード・離脱ガード・即時反映）

- Autosave はユーザー操作中（入力/クリック/フォーカス移動中）にスキップする
- 未保存変更がある場合、ブラウザ更新/閉じるで警告する
- 「一覧」ボタンは未保存変更がある場合 confirm を出す
- 保存成功時に templateListStore.upsertMeta で name/updatedAt を即時反映する
