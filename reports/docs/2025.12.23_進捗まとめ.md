# PlugBits Reports – PDF帳票エンジン 開発まとめ（P1〜P3）

## 概要
kintone / static データを元に、テンプレートエディタで設計したレイアウトを
Cloudflare Workers + pdf-lib で PDF 出力する帳票SaaS。

本スレッドでは **P1〜P3（帳票レイアウト基盤＋テーブル描画＋文字溢れ対応）** を集中的に実装・検証した。

---

## P1：テンプレートエディタ & 基本描画（ほぼ完了）

### 実装済み
- TemplateEditor UI
  - Canvas / 右ペインを固定高さ＋内部スクロール（Sticky 相当）
  - 要素一覧の表示名をユーザー向け表記に整理（内部ID非表示）
- Header / Footer / Body の region 分離
- repeatOnEveryPage / footerRepeatMode 対応
- 画像要素
  - URL 指定で事前 preload → embed
  - 取得失敗時はプレースホルダ描画
- Header 要素の Y 見切れ調整（fromTop / yHeader）

### 確認済み
- 1ページ目のみ表示 / 全ページ表示の切り替えOK
- PDF とエディタ表示の乖離は実用範囲に収束

---

## P2：PDF生成 Worker 基盤（完了）

### Worker API
- `/render` / `/render-preview`（POST）
- template または templateId 指定対応
- fixture 指定対応（?fixture=longtext 等）

### 実装済み
- fontkit + 日本語フォント埋め込み
- ページサイズ / 向き（A4 portrait/landscape）
- ヘッダー再描画付きのマルチページ対応
- フッター領域の自動見積（footerReserveHeight）

---

## P3：テーブル描画・折り返し・桁問題対応（完了）

### テーブル描画
- サブテーブル（kintoneSubtable）対応
- ページ跨ぎ対応（ヘッダー再描画）
- rowHeight / headerHeight 設定対応
- 罫線描画（showGrid）

### 長文テスト（fixture）
- longtext fixture を用いて検証
- ItemName / CustomerName / Remarks の折り返し表示を確認
- rowHeight を上げることで複数行表示が視認可能

### 数値表示の仕様整理
- 数字は折り返さない
- 右寄せ + shrink-to-fit（フォントサイズ縮小）で1行表示
- 通常業務では桁落ち対策は不要だが、
  **2^53超の unsafe number を検知する安全弁を実装**

### 桁落ち対策（重要）
- resolveDataSource() にて
  - Number.isSafeInteger(value) === false を検知
  - console.warn('[unsafe-number]', fieldCode, value)
  - PDF生成は継続（止めない）
- fixture の bigNumber / longtext は number 巨大値を避け、string or 実務桁に修正

---

## 現在の到達点
- 実務で使える帳票レイアウト基盤は完成
- 折り返し / 縮小 / ページ跨ぎ / ヘッダー・フッター挙動は確認済み
- 次フェーズ（P4）に進める状態

---

## 次フェーズ候補（P4）
- テーブル列ごとの align / shrink 設定の明示化
- 合計行（フッター合計 / 小計）の自動描画
- 複数テーブル対応 or 明示的制限
- テンプレート保存・復元の永続化設計
