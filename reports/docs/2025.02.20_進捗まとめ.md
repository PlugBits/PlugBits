# Y座標系統一フェーズ（Admin / Canvas / PDF）

## 1. 発生していた問題

- Adminテンプレでは上下が正常
- Canvas表示は正常（Top基準）
- PDF出力で上下が反転していた

### 原因
Adminテンプレは **Top-origin（上基準）** で保存されていたが、
PDF描画時に無条件で

    pdfY = pageHeight - yTop - height

を適用していたため、
Top基準 → さらに反転 → 上下逆転が発生。

migrationログ:
- rawYMode=top
- didYMode=false
- それでも render 側で flip 実行

= 二重変換状態

---

## 2. 修正方針

### 座標の正規ルールを明確化

- Adminテンプレ保存形式: **Top-origin**
- Canvas: Top-origin（そのまま描画）
- PDF: Bottom-origin

→ PDF描画時にのみ **1回だけ変換**

    if (templateYMode === 'top') {
        pdfY = pageHeight - yTop - height
    }

---

## 3. 確認ログ

- DBG_PAGE → templatePageH=842, pdfPageH=842
- DBG_XFORM → scaleX=1, scaleY=1
- DBG_FLIPY → usedPageH=842 一貫
- PDF表示 → 上下正常

上下反転問題は解消。

---

# 現在の状態

✅ Y-origin は統一された  
✅ 二重反転は解消  
⚠ 微妙な縦方向ズレが残る  

---

# 次フェーズ：微ズレの原因候補

残っているズレは主に以下の可能性：

### 1) テキスト描画時のベースライン差
pdf-lib は baseline 基準で描画されるため

    drawTextY = rectPdfY + fontSize * α

のような補正が入っている可能性。

ログ:
- rectPdfY: 771
- drawTextY: 772.6

→ baseline補正あり

---

### 2) lineHeight / fontSize 計算差

Canvas:
- CSS line-height ベース

PDF:
- フォントメトリクスベース

---

### 3) テーブルヘッダー高さの加算順序

    uiY=270
    uiH=24
    outY=548

ここは理論上正しいが、
headerBottomYとの相対位置ズレの可能性あり。

---

# 次にやること（ズレ潰し）

1. テキスト系と矩形系を分離検証
2. rect と text を同一Yで描画して比較
3. baseline補正値を固定するかどうか決定
4. tableヘッダーとbodyの境界を可視化デバッグ

---

# 結論

- 座標反転バグは解消
- 残りは「描画レイヤーの基準差」問題
- これは構造バグではなく精度チューニング段階